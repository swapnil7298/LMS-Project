{% extends "base.html" %}

{% block title %}Verify Your Account{% endblock %}

{% block content %}
<section class="auth-section">
    <div class="container">
        <div class="auth-card">
            <div class="auth-header">
                <h2>Check Your Email</h2>
                <p>We've sent a 6-digit verification code to <strong>{{ email }}</strong>.</p>
            </div>
            
            <form class="auth-form" action="/api/verify-otp" method="POST">
                <input type="hidden" id="user_email" name="email" value="{{ email }}">

                <div class="form-group">
                    <label for="otp">Verification Code</label>
                    <input type="text" id="otp" name="otp" placeholder="Enter 6-digit code" required maxlength="6" pattern="\d{6}" title="Please enter a 6-digit number.">
                </div>

                <button type="submit" class="btn btn-primary btn-block">Verify and Log In</button>
            </form>

            <div class="auth-footer">
                <p>Didn't receive a code? 
                    <button id="resend-btn" class="link-button">Resend Code</button>
                </p>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const resendBtn = document.getElementById('resend-btn');
    const userEmail = document.getElementById('user_email').value;

    resendBtn.addEventListener('click', function() {
        // Disable the button and show a sending message
        resendBtn.disabled = true;
        resendBtn.textContent = 'Sending...';

        // Call our new API endpoint
        fetch('/api/resend-otp', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email: userEmail }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resendBtn.textContent = 'Code Sent!';
            } else {
                resendBtn.textContent = 'Error!';
                console.error(data.message);
            }

            // Start a 30-second cooldown timer
            let countdown = 30;
            const interval = setInterval(() => {
                resendBtn.textContent = `Resend in ${countdown--}s`;
                if (countdown < 0) {
                    clearInterval(interval);
                    resendBtn.disabled = false;
                    resendBtn.textContent = 'Resend Code';
                }
            }, 1000);
        })
        .catch(error => {
            console.error('Fetch error:', error);
            resendBtn.textContent = 'Error!';
            // Re-enable after a short delay on error
            setTimeout(() => {
                resendBtn.disabled = false;
                resendBtn.textContent = 'Resend Code';
            }, 3000);
        });
    });
});
</script>

<style>
    .link-button {
        background: none;
        border: none;
        color: var(--primary-color);
        font-weight: 600;
        text-decoration: none;
        cursor: pointer;
        padding: 0;
        font-family: inherit;
        font-size: inherit;
    }
    .link-button:disabled {
        color: var(--muted-text-color);
        cursor: not-allowed;
    }
</style>
{% endblock %}